$(window).load(function() {
  loadScript();
});

var map;
var styleArray = [{"featureType":"landscape.man_made","elementType":"geometry","stylers":[{"color":"#f7f1df"}]},{"featureType":"landscape.natural","elementType":"geometry","stylers":[{"color":"#d0e3b4"}]},{"featureType":"landscape.natural.terrain","elementType":"geometry","stylers":[{"visibility":"off"}]},{"featureType":"poi","elementType":"labels","stylers":[{"visibility":"off"}]},{"featureType":"poi.business","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"poi.medical","elementType":"geometry","stylers":[{"color":"#fbd3da"}]},{"featureType":"poi.park","elementType":"geometry","stylers":[{"color":"#bde6ab"}]},{"featureType":"road","elementType":"geometry.stroke","stylers":[{"visibility":"off"}]},{"featureType":"road","elementType":"labels","stylers":[{"visibility":"off"}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"color":"#ffe15f"}]},{"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"color":"#efd151"}]},{"featureType":"road.arterial","elementType":"geometry.fill","stylers":[{"color":"#ffffff"}]},{"featureType":"road.local","elementType":"geometry.fill","stylers":[{"color":"black"}]},{"featureType":"transit.station.airport","elementType":"geometry.fill","stylers":[{"color":"#cfb2db"}]},{"featureType":"water","elementType":"geometry","stylers":[{"color":"#a2daf2"}]}]

function initialize() {
  var mapOptions = {
          center: new google.maps.LatLng(32.715403, -117.158048),
          zoom: 14,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          panControl: true,
          scaleControl: false,
          streetViewControl: true,
          overviewMapControl: true,
          styles: styleArray
        };

  map = new google.maps.Map(document.getElementById("map"),mapOptions);

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };

      $.post("/location?location[lat]="+pos.lat + "&location[lng]="+pos.lng)

      createCustomMarker(pos,map)
      map.setCenter(pos);
    }, function() {
      handleLocationError(true, infoWindow, map.getCenter());
    });
  } else {
    handleLocationError(false, infoWindow, map.getCenter());
  }

  function handleLocationError(browserHasGeolocation, infoWindow, pos) {
    infoWindow.setPosition(pos);
    infoWindow.setContent(browserHasGeolocation ?
                          'Error: The Geolocation service failed.' :
                          'Error: Your browser doesn\'t support geolocation.');
  }

  var geocoding  = new google.maps.Geocoder();
  $("#submit_button_geocoding").click(function(){
    codeAddress(geocoding);
  });
}

function codeAddress(geocoding){
  var address = $("#search_box_geocoding").val();
  if(address.length > 0){
    geocoding.geocode({'address': address},function(results, status){
      if(status == google.maps.GeocoderStatus.OK){
        map.setZoom(16);
        map.setCenter(results[0].geometry.location);
        createCustomMarker(results[0].geometry.location,map)
        }else{
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
  }else{
    alert("Search field can't be blank");
  }
}

function createImage(url){
  var image = {
    url: url,
    size: new google.maps.Size(26, 47),
    origin: new google.maps.Point(0,0),
    anchor: new google.maps.Point(32, 47)
  };
  return image;
}

function createCustomMarker(coords,map){
  marker = new google.maps.Marker({
    position: coords,
    map: map,
    icon: createImage("/assets/drop-small.png")
  });
}

function loadScript() {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  var url =
    'https://maps.googleapis.com/maps/api/js?key='+
    '<%= ENV['GOOGLE_KEY'] %>'+
    '&libraries=drawing'+
    '&callback=initialize';
  script.src = url;
  document.body.appendChild(script);
}
